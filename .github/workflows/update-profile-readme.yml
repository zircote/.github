# Profile README Auto-Update Workflow
# Analyzes public GitHub activity and updates profile README with:
# - Top 8 most significant active repos (weighted by contributions and activity)
# - New repos from activity feed
#
# Uses GitHub Copilot agents for content generation
# Runs weekly on Sunday at midnight UTC, or manually via workflow_dispatch

name: Update Profile README

on:
  schedule:
    - cron: '0 0 * * 0'  # Sunday at 00:00 UTC
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Preview changes without committing'
        required: false
        default: false
        type: boolean
      top-repos-count:
        description: 'Number of top repos to feature'
        required: false
        default: '8'
        type: string

permissions:
  contents: write
  pull-requests: write

env:
  GITHUB_USER: zircote
  TOP_REPOS_COUNT: ${{ inputs.top-repos-count || '8' }}

jobs:
  # ===========================================================================
  # Analyze GitHub Activity
  # ===========================================================================
  analyze-activity:
    name: Analyze GitHub Activity
    runs-on: ubuntu-latest
    outputs:
      top-repos-json: ${{ steps.analyze.outputs.top_repos }}
      new-repos-json: ${{ steps.analyze.outputs.new_repos }}
      activity-summary: ${{ steps.analyze.outputs.summary }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install requests python-dateutil

      - name: Analyze activity
        id: analyze
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_USER: ${{ env.GITHUB_USER }}
          TOP_COUNT: ${{ env.TOP_REPOS_COUNT }}
        run: |
          python scripts/analyze-github-activity.py \
            --user "$GITHUB_USER" \
            --top-count "$TOP_COUNT" \
            --output-format github-output

  # ===========================================================================
  # Generate README Content
  # ===========================================================================
  generate-content:
    name: Generate README Content
    runs-on: ubuntu-latest
    needs: analyze-activity
    outputs:
      readme-content: ${{ steps.generate.outputs.content }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '22'

      - name: Generate README sections
        id: generate
        env:
          TOP_REPOS: ${{ needs.analyze-activity.outputs.top-repos-json }}
          NEW_REPOS: ${{ needs.analyze-activity.outputs.new-repos-json }}
          ACTIVITY_SUMMARY: ${{ needs.analyze-activity.outputs.activity-summary }}
        run: |
          node scripts/generate-readme-sections.js

  # ===========================================================================
  # Update README
  # ===========================================================================
  update-readme:
    name: Update README
    runs-on: ubuntu-latest
    needs: [analyze-activity, generate-content]
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'

      - name: Update README
        id: update
        env:
          TOP_REPOS: ${{ needs.analyze-activity.outputs.top-repos-json }}
          NEW_REPOS: ${{ needs.analyze-activity.outputs.new-repos-json }}
          DRY_RUN: ${{ inputs.dry-run || 'false' }}
        run: |
          python scripts/update-profile-readme.py \
            --readme-path profile/README.md \
            --top-repos "$TOP_REPOS" \
            --new-repos "$NEW_REPOS" \
            $([[ "$DRY_RUN" == "true" ]] && echo "--dry-run")

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet profile/README.md; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes detected in README"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected in README"
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true' && inputs.dry-run != true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="auto/profile-readme-update-$(date +%Y%m%d)"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH"
          git add profile/README.md
          git commit -m "docs(profile): update activity highlights

          - Updated top active repositories
          - Refreshed new repositories section
          - Auto-generated from GitHub activity analysis

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: GitHub Actions <actions@github.com>"

          git push -u origin "$BRANCH"

          gh pr create \
            --title "docs(profile): Weekly profile README update" \
            --body "$(cat <<'EOF'
          ## Summary

          Automated weekly update to profile README based on GitHub activity analysis.

          ### Changes
          - **Top Active Repos**: Updated ranking based on recent contributions, commits, and activity
          - **New Repos**: Refreshed list of recently created repositories

          ### Weighting Factors
          - Commits in the last 90 days (40%)
          - Stars received (20%)
          - Forks (15%)
          - Issues/PRs activity (15%)
          - Recent pushes (10%)

          ---

          ðŸ¤– Generated with GitHub Actions
          EOF
          )" \
            --label "documentation"

      - name: Generate summary
        if: always()
        env:
          CHANGED: ${{ steps.changes.outputs.changed }}
          DRY_RUN: ${{ inputs.dry-run || 'false' }}
        run: |
          {
            echo "## Profile README Update Summary"
            echo ""
            if [[ "$DRY_RUN" == "true" ]]; then
              echo "> **Dry Run Mode** - No changes were committed"
              echo ""
            fi
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| Changes Detected | $CHANGED |"
            echo "| Top Repos Analyzed | ${{ env.TOP_REPOS_COUNT }} |"
            echo "| Run Type | $([[ '${{ github.event_name }}' == 'schedule' ]] && echo 'Scheduled' || echo 'Manual') |"
          } >> "$GITHUB_STEP_SUMMARY"
