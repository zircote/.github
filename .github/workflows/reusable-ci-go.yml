# Reusable Go CI Workflow
# Provides centralized Go CI for all repositories
#
# Security Note: This workflow only uses workflow_call inputs (controlled by caller)
# and internal job status values. No untrusted user input is used in run commands.
#
# Usage in consuming workflows:
#   jobs:
#     ci:
#       uses: org-github/.github/workflows/reusable-ci-go.yml@main
#       with:
#         go-version: '1.23'
#         coverage-threshold: 80
#       secrets: inherit

name: Go CI

on:
  workflow_call:
    inputs:
      go-version:
        description: 'Go version to use'
        required: false
        type: string
        default: '1.23'
      go-versions-matrix:
        description: 'JSON array of Go versions for matrix testing (e.g., ''["1.22", "1.23"]'')'
        required: false
        type: string
        default: '["1.23"]'
      coverage-threshold:
        description: 'Minimum coverage percentage to pass (0 to disable)'
        required: false
        type: number
        default: 80
      enable-matrix:
        description: 'Enable matrix testing with multiple Go versions'
        required: false
        type: boolean
        default: false
      enable-build:
        description: 'Run build step after tests pass'
        required: false
        type: boolean
        default: true
      golangci-lint-version:
        description: 'golangci-lint version to use'
        required: false
        type: string
        default: 'v1.62.2'
      lint-timeout:
        description: 'Timeout for golangci-lint'
        required: false
        type: string
        default: '5m'
      working-directory:
        description: 'Working directory for commands'
        required: false
        type: string
        default: '.'
      upload-coverage:
        description: 'Upload coverage to Codecov'
        required: false
        type: boolean
        default: true
      runs-on:
        description: 'Runner to use'
        required: false
        type: string
        default: 'ubuntu-latest'
    outputs:
      coverage-percentage:
        description: 'Test coverage percentage'
        value: ${{ jobs.test.outputs.coverage }}

permissions:
  contents: read

jobs:
  # ===========================================================================
  # Lint - Run golangci-lint
  # ===========================================================================
  lint:
    name: Lint
    runs-on: ${{ inputs.runs-on }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v5.2.0
        with:
          go-version: ${{ inputs.go-version }}
          cache: true
          cache-dependency-path: ${{ inputs.working-directory }}/go.sum

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@1e7e51e771db61008b38414a730f564565cf7c20 # v6.5.0
        with:
          version: ${{ inputs.golangci-lint-version }}
          args: --timeout=${{ inputs.lint-timeout }}
          working-directory: ${{ inputs.working-directory }}

  # ===========================================================================
  # Test - Run tests with coverage (single version)
  # ===========================================================================
  test:
    name: Test
    runs-on: ${{ inputs.runs-on }}
    if: ${{ !inputs.enable-matrix }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    outputs:
      coverage: ${{ steps.coverage.outputs.percentage }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v5.2.0
        with:
          go-version: ${{ inputs.go-version }}
          cache: true
          cache-dependency-path: ${{ inputs.working-directory }}/go.sum

      - name: Run tests with coverage
        id: coverage
        env:
          THRESHOLD: ${{ inputs.coverage-threshold }}
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

          # Extract coverage percentage
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: ${COVERAGE}%"
          echo "percentage=${COVERAGE%.*}" >> "$GITHUB_OUTPUT"

          # Check threshold
          if [[ "$THRESHOLD" -gt 0 ]]; then
            if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
              echo "::error::Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
              exit 1
            fi
          fi

      - name: Upload coverage report
        if: inputs.upload-coverage
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.4.2
        with:
          files: coverage.out
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload coverage artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.1
        with:
          name: coverage-report
          path: ${{ inputs.working-directory }}/coverage.out
          retention-days: 30

  # ===========================================================================
  # Test Matrix - Run tests across multiple Go versions
  # ===========================================================================
  test-matrix:
    name: Test (Go ${{ matrix.go-version }})
    runs-on: ${{ inputs.runs-on }}
    if: ${{ inputs.enable-matrix }}
    strategy:
      fail-fast: false
      matrix:
        go-version: ${{ fromJson(inputs.go-versions-matrix) }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v5.2.0
        with:
          go-version: ${{ matrix.go-version }}
          cache: true
          cache-dependency-path: ${{ inputs.working-directory }}/go.sum

      - name: Run tests with coverage
        env:
          THRESHOLD: ${{ inputs.coverage-threshold }}
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: ${COVERAGE}%"

          if [[ "$THRESHOLD" -gt 0 ]]; then
            if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
              echo "::error::Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
              exit 1
            fi
          fi

      - name: Upload coverage report
        if: inputs.upload-coverage && matrix.go-version == fromJson(inputs.go-versions-matrix)[0]
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.4.2
        with:
          files: coverage.out
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ===========================================================================
  # Build - Compile binaries
  # ===========================================================================
  build:
    name: Build
    runs-on: ${{ inputs.runs-on }}
    if: ${{ inputs.enable-build }}
    needs: [lint, test, test-matrix]
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v5.2.0
        with:
          go-version: ${{ inputs.go-version }}
          cache: true
          cache-dependency-path: ${{ inputs.working-directory }}/go.sum

      - name: Build
        run: |
          if [[ -f "Makefile" ]] && grep -q "^build:" Makefile; then
            make build
          else
            go build -v ./...
          fi

  # ===========================================================================
  # Summary - Aggregate results
  # ===========================================================================
  all-checks-pass:
    name: All Checks Pass
    if: always()
    needs: [lint, test, test-matrix, build]
    runs-on: ubuntu-latest
    env:
      LINT_RESULT: ${{ needs.lint.result }}
      TEST_RESULT: ${{ needs.test.result }}
      TEST_MATRIX_RESULT: ${{ needs.test-matrix.result }}
      BUILD_RESULT: ${{ needs.build.result }}
      ENABLE_MATRIX: ${{ inputs.enable-matrix }}
      ENABLE_BUILD: ${{ inputs.enable-build }}
    steps:
      - name: Check all jobs passed
        run: |
          # Lint must pass
          if [[ "$LINT_RESULT" != "success" ]]; then
            echo "Lint failed"
            exit 1
          fi

          # Either test or test-matrix must pass (depending on config)
          if [[ "$ENABLE_MATRIX" == "true" ]]; then
            if [[ "$TEST_MATRIX_RESULT" != "success" ]]; then
              echo "Matrix tests failed"
              exit 1
            fi
          else
            if [[ "$TEST_RESULT" != "success" ]]; then
              echo "Tests failed"
              exit 1
            fi
          fi

          # Build must pass if enabled
          if [[ "$ENABLE_BUILD" == "true" ]] && [[ "$BUILD_RESULT" != "success" ]]; then
            echo "Build failed"
            exit 1
          fi

          echo "All checks passed!"
