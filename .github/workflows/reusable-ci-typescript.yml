# Reusable TypeScript CI Workflow
# Provides centralized TypeScript/Node.js CI for all repositories using pnpm
#
# Security Note: This workflow only uses workflow_call inputs (controlled by caller)
# and internal job status values. No untrusted user input is used in run commands.
#
# Usage in consuming workflows:
#   jobs:
#     ci:
#       uses: org-github/.github/workflows/reusable-ci-typescript.yml@main
#       with:
#         node-version: '22'
#         coverage-threshold: 80
#       secrets: inherit

name: TypeScript CI

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: '22'
      node-versions-matrix:
        description: 'JSON array of Node.js versions for matrix testing (e.g., ''["20", "22"]'')'
        required: false
        type: string
        default: '["22"]'
      coverage-threshold:
        description: 'Minimum coverage percentage to pass (0 to disable)'
        required: false
        type: number
        default: 80
      enable-matrix:
        description: 'Enable matrix testing with multiple Node.js versions'
        required: false
        type: boolean
        default: false
      enable-build:
        description: 'Run build step after tests pass'
        required: false
        type: boolean
        default: true
      working-directory:
        description: 'Working directory for commands'
        required: false
        type: string
        default: '.'
      upload-coverage:
        description: 'Upload coverage to Codecov'
        required: false
        type: boolean
        default: true
      upload-artifacts:
        description: 'Upload build artifacts'
        required: false
        type: boolean
        default: true
      runs-on:
        description: 'Runner to use'
        required: false
        type: string
        default: 'ubuntu-latest'
    outputs:
      coverage-percentage:
        description: 'Test coverage percentage'
        value: ${{ jobs.test.outputs.coverage }}

permissions:
  contents: read

jobs:
  # ===========================================================================
  # Lint - Check code style and formatting
  # ===========================================================================
  lint:
    name: Lint
    runs-on: ${{ inputs.runs-on }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'pnpm'
          cache-dependency-path: ${{ inputs.working-directory }}/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm run lint

      - name: Check formatting
        run: pnpm run format:check

  # ===========================================================================
  # Type Check - Static type analysis
  # ===========================================================================
  typecheck:
    name: Type Check
    runs-on: ${{ inputs.runs-on }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'pnpm'
          cache-dependency-path: ${{ inputs.working-directory }}/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run type check
        run: pnpm run typecheck

  # ===========================================================================
  # Test - Run tests with coverage (single version)
  # ===========================================================================
  test:
    name: Test
    runs-on: ${{ inputs.runs-on }}
    if: ${{ !inputs.enable-matrix }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    outputs:
      coverage: ${{ steps.coverage.outputs.percentage }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'pnpm'
          cache-dependency-path: ${{ inputs.working-directory }}/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests with coverage
        id: coverage
        run: |
          pnpm run test:coverage

          # Extract coverage from lcov.info if available
          if [[ -f "coverage/lcov.info" ]]; then
            LINES=$(grep -E "^LF:" coverage/lcov.info | sed 's/LF://' | paste -sd+ | bc)
            HITS=$(grep -E "^LH:" coverage/lcov.info | sed 's/LH://' | paste -sd+ | bc)
            if [[ "$LINES" -gt 0 ]]; then
              PERCENTAGE=$((HITS * 100 / LINES))
              echo "percentage=$PERCENTAGE" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Check coverage threshold
        if: inputs.coverage-threshold > 0
        env:
          COVERAGE: ${{ steps.coverage.outputs.percentage }}
          THRESHOLD: ${{ inputs.coverage-threshold }}
        run: |
          if [[ -n "$COVERAGE" ]] && [[ "$COVERAGE" -lt "$THRESHOLD" ]]; then
            echo "Coverage $COVERAGE% is below threshold $THRESHOLD%"
            exit 1
          fi

      - name: Upload coverage report
        if: inputs.upload-coverage
        uses: codecov/codecov-action@ad3126e916f78f00edff4ed0317cf185271ccc2d # v5.4.2
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ===========================================================================
  # Test Matrix - Run tests across multiple Node.js versions
  # ===========================================================================
  test-matrix:
    name: Test (Node.js ${{ matrix.node-version }})
    runs-on: ${{ inputs.runs-on }}
    if: ${{ inputs.enable-matrix }}
    strategy:
      fail-fast: false
      matrix:
        node-version: ${{ fromJson(inputs.node-versions-matrix) }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'
          cache-dependency-path: ${{ inputs.working-directory }}/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests with coverage
        run: pnpm run test:coverage

      - name: Upload coverage report
        if: inputs.upload-coverage && matrix.node-version == fromJson(inputs.node-versions-matrix)[0]
        uses: codecov/codecov-action@ad3126e916f78f00edff4ed0317cf185271ccc2d # v5.4.2
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ===========================================================================
  # Build - Compile and package
  # ===========================================================================
  build:
    name: Build
    runs-on: ${{ inputs.runs-on }}
    if: ${{ inputs.enable-build }}
    needs: [lint, typecheck, test, test-matrix]
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'pnpm'
          cache-dependency-path: ${{ inputs.working-directory }}/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Upload build artifacts
        if: inputs.upload-artifacts
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: dist
          path: ${{ inputs.working-directory }}/dist/
          retention-days: 7

  # ===========================================================================
  # Summary - Aggregate results
  # ===========================================================================
  all-checks-pass:
    name: All Checks Pass
    if: always()
    needs: [lint, typecheck, test, test-matrix, build]
    runs-on: ubuntu-latest
    env:
      LINT_RESULT: ${{ needs.lint.result }}
      TYPECHECK_RESULT: ${{ needs.typecheck.result }}
      TEST_RESULT: ${{ needs.test.result }}
      TEST_MATRIX_RESULT: ${{ needs.test-matrix.result }}
      BUILD_RESULT: ${{ needs.build.result }}
      ENABLE_MATRIX: ${{ inputs.enable-matrix }}
      ENABLE_BUILD: ${{ inputs.enable-build }}
    steps:
      - name: Check all jobs passed
        run: |
          # Lint and typecheck must pass
          if [[ "$LINT_RESULT" != "success" ]] || [[ "$TYPECHECK_RESULT" != "success" ]]; then
            echo "Lint or typecheck failed"
            exit 1
          fi

          # Either test or test-matrix must pass (depending on config)
          if [[ "$ENABLE_MATRIX" == "true" ]]; then
            if [[ "$TEST_MATRIX_RESULT" != "success" ]]; then
              echo "Matrix tests failed"
              exit 1
            fi
          else
            if [[ "$TEST_RESULT" != "success" ]]; then
              echo "Tests failed"
              exit 1
            fi
          fi

          # Build must pass if enabled
          if [[ "$ENABLE_BUILD" == "true" ]] && [[ "$BUILD_RESULT" != "success" ]]; then
            echo "Build failed"
            exit 1
          fi

          echo "All checks passed!"
