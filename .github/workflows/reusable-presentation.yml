# Reusable Presentation Generation Workflow
# Generates slide deck presentations from markdown or issue prompts
#
# Usage in consuming workflows:
#   jobs:
#     generate:
#       uses: zircote/.github/.github/workflows/reusable-presentation.yml@main
#       with:
#         source: 'docs/presentations/drafts/my-deck.md'
#         formats: 'pdf,html,pptx'
#         style: 'systematic-velocity'
#       secrets: inherit

name: Generate Presentation

on:
  workflow_call:
    inputs:
      source:
        description: 'Path to markdown source file or "issue" to parse from triggering issue'
        required: true
        type: string
      formats:
        description: 'Comma-separated output formats: pdf,html,pptx,md'
        required: false
        type: string
        default: 'pdf'
      style:
        description: 'Design style: systematic-velocity, clean-minimal, technical-blueprint, marketing-bold'
        required: false
        type: string
        default: 'systematic-velocity'
      output-dir:
        description: 'Output directory for generated files'
        required: false
        type: string
        default: 'docs/presentations/output'
      enable-research:
        description: 'Enable web research for content enrichment'
        required: false
        type: boolean
        default: false
      repository-analysis:
        description: 'Repository to analyze (owner/repo format)'
        required: false
        type: string
        default: ''
      create-pr:
        description: 'Create PR with generated presentation'
        required: false
        type: boolean
        default: true
      runs-on:
        description: 'Runner to use'
        required: false
        type: string
        default: 'ubuntu-latest'
    outputs:
      pdf-path:
        description: 'Path to generated PDF'
        value: ${{ jobs.generate.outputs.pdf-path }}
      html-path:
        description: 'Path to generated HTML directory'
        value: ${{ jobs.generate.outputs.html-path }}
      pptx-path:
        description: 'Path to generated PowerPoint'
        value: ${{ jobs.generate.outputs.pptx-path }}
      pr-url:
        description: 'URL of created PR (if enabled)'
        value: ${{ jobs.create-pr.outputs.pr-url }}

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ===========================================================================
  # Research - Optional content research phase
  # ===========================================================================
  research:
    name: Research
    runs-on: ${{ inputs.runs-on }}
    if: ${{ inputs.enable-research || inputs.repository-analysis != '' }}
    outputs:
      research-content: ${{ steps.research.outputs.content }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Analyze Repository
        id: repo-analysis
        if: ${{ inputs.repository-analysis != '' }}
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ inputs.repository-analysis }}
        run: |
          echo "Analyzing repository: $REPO"

          # Get repository info
          gh repo view "$REPO" --json name,description,stargazerCount,forkCount,pushedAt > repo-info.json

          # Get recent releases
          gh release list --repo "$REPO" --limit 5 --json tagName,name,publishedAt > releases.json 2>/dev/null || echo "[]" > releases.json

          # Get issue/PR stats
          OPEN_ISSUES=$(gh issue list --repo "$REPO" --state open --json number | jq length)
          CLOSED_ISSUES=$(gh issue list --repo "$REPO" --state closed --limit 100 --json number | jq length)
          OPEN_PRS=$(gh pr list --repo "$REPO" --state open --json number | jq length)

          # Get recent commits
          gh api "repos/$REPO/commits?per_page=10" --jq '.[].commit.message' > recent-commits.txt 2>/dev/null || true

          # Compile research
          cat << EOF > research-content.md
          ## Repository Analysis: $REPO

          $(cat repo-info.json | jq -r '"### " + .name + "\n\n" + .description + "\n\n- Stars: " + (.stargazerCount|tostring) + "\n- Forks: " + (.forkCount|tostring) + "\n- Last Push: " + .pushedAt')

          ### Activity
          - Open Issues: $OPEN_ISSUES
          - Closed Issues: $CLOSED_ISSUES
          - Open PRs: $OPEN_PRS

          ### Recent Releases
          $(cat releases.json | jq -r '.[] | "- " + .tagName + ": " + .name + " (" + .publishedAt + ")"')

          ### Recent Commits
          $(head -5 recent-commits.txt | sed 's/^/- /')
          EOF

          echo "Research content generated"

      - name: Upload Research Artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4.6.0
        with:
          name: research-content
          path: research-content.md
          retention-days: 7

  # ===========================================================================
  # Generate - Main presentation generation
  # ===========================================================================
  generate:
    name: Generate Presentation
    runs-on: ${{ inputs.runs-on }}
    needs: [research]
    if: ${{ !cancelled() }}
    outputs:
      pdf-path: ${{ steps.generate.outputs.pdf-path }}
      html-path: ${{ steps.generate.outputs.html-path }}
      pptx-path: ${{ steps.generate.outputs.pptx-path }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download Research (if available)
        if: ${{ needs.research.result == 'success' }}
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: research-content
          path: .research/
        continue-on-error: true

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v6.0.1

      - name: Install Dependencies
        run: |
          uv pip install --system reportlab python-pptx Pillow jinja2 markdown pyyaml

      - name: Ensure Output Directory
        run: mkdir -p "${{ inputs.output-dir }}"

      - name: Generate Presentation
        id: generate
        env:
          SOURCE: ${{ inputs.source }}
          FORMATS: ${{ inputs.formats }}
          STYLE: ${{ inputs.style }}
          OUTPUT_DIR: ${{ inputs.output-dir }}
        run: |
          echo "Generating presentation from: $SOURCE"
          echo "Formats: $FORMATS"
          echo "Style: $STYLE"

          # Get base name from source
          BASENAME=$(basename "$SOURCE" .md)

          # Run generation script
          python docs/presentations/generate.py \
            --input "$SOURCE" \
            --output "$OUTPUT_DIR" \
            --formats "$FORMATS" \
            --style "$STYLE" \
            --research-dir ".research/"

          # Set outputs based on formats
          if [[ "$FORMATS" == *"pdf"* ]]; then
            echo "pdf-path=$OUTPUT_DIR/$BASENAME.pdf" >> "$GITHUB_OUTPUT"
          fi
          if [[ "$FORMATS" == *"html"* ]]; then
            echo "html-path=$OUTPUT_DIR/$BASENAME/" >> "$GITHUB_OUTPUT"
          fi
          if [[ "$FORMATS" == *"pptx"* ]]; then
            echo "pptx-path=$OUTPUT_DIR/$BASENAME.pptx" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload Presentation Artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4.6.0
        with:
          name: presentation-output
          path: ${{ inputs.output-dir }}/
          retention-days: 30

  # ===========================================================================
  # Create PR - Optional PR creation with generated presentation
  # ===========================================================================
  create-pr:
    name: Create PR
    runs-on: ${{ inputs.runs-on }}
    needs: [generate]
    if: ${{ inputs.create-pr && needs.generate.result == 'success' }}
    outputs:
      pr-url: ${{ steps.create-pr.outputs.pr-url }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download Presentation
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: presentation-output
          path: ${{ inputs.output-dir }}/

      - name: Create Branch and PR
        id: create-pr
        env:
          GH_TOKEN: ${{ github.token }}
          SOURCE: ${{ inputs.source }}
          OUTPUT_DIR: ${{ inputs.output-dir }}
        run: |
          BASENAME=$(basename "$SOURCE" .md)
          BRANCH="presentation/$BASENAME-$(date +%Y%m%d%H%M%S)"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH"
          git add "$OUTPUT_DIR/"
          git commit -m "feat(presentation): generate $BASENAME

          Generated presentation from $SOURCE

          Formats: ${{ inputs.formats }}
          Style: ${{ inputs.style }}"

          git push origin "$BRANCH"

          PR_URL=$(gh pr create \
            --title "feat(presentation): $BASENAME" \
            --body "## Generated Presentation

          **Source**: \`$SOURCE\`
          **Style**: ${{ inputs.style }}
          **Formats**: ${{ inputs.formats }}

          ### Generated Files
          $(find "$OUTPUT_DIR" -name "$BASENAME*" -type f | sed 's/^/- /')

          ---
          *Auto-generated by presentation workflow*" \
            --base main)

          echo "pr-url=$PR_URL" >> "$GITHUB_OUTPUT"
          echo "Created PR: $PR_URL"

  # ===========================================================================
  # Summary
  # ===========================================================================
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [research, generate, create-pr]
    if: always()
    steps:
      - name: Generate Summary
        env:
          RESEARCH_RESULT: ${{ needs.research.result }}
          GENERATE_RESULT: ${{ needs.generate.result }}
          PR_RESULT: ${{ needs.create-pr.result }}
          PDF_PATH: ${{ needs.generate.outputs.pdf-path }}
          HTML_PATH: ${{ needs.generate.outputs.html-path }}
          PPTX_PATH: ${{ needs.generate.outputs.pptx-path }}
          PR_URL: ${{ needs.create-pr.outputs.pr-url }}
        run: |
          echo "## Presentation Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Research | $RESEARCH_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "| Generate | $GENERATE_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "| Create PR | $PR_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "$GENERATE_RESULT" == "success" ]]; then
            echo "### Generated Files" >> $GITHUB_STEP_SUMMARY
            [[ -n "$PDF_PATH" ]] && echo "- PDF: \`$PDF_PATH\`" >> $GITHUB_STEP_SUMMARY
            [[ -n "$HTML_PATH" ]] && echo "- HTML: \`$HTML_PATH\`" >> $GITHUB_STEP_SUMMARY
            [[ -n "$PPTX_PATH" ]] && echo "- PPTX: \`$PPTX_PATH\`" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ -n "$PR_URL" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Pull Request" >> $GITHUB_STEP_SUMMARY
            echo "[$PR_URL]($PR_URL)" >> $GITHUB_STEP_SUMMARY
          fi
